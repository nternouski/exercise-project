/*! For license information please see index.js.LICENSE.txt */
(()=>{"use strict";var __webpack_modules__={"./src/https/index.ts":function(__unused_webpack_module,exports,__webpack_require__){eval('\r\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    var desc = Object.getOwnPropertyDescriptor(m, k);\r\n    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\r\n      desc = { enumerable: true, get: function() { return m[k]; } };\r\n    }\r\n    Object.defineProperty(o, k2, desc);\r\n}) : (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    o[k2] = m[k];\r\n}));\r\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\r\n    Object.defineProperty(o, "default", { enumerable: true, value: v });\r\n}) : function(o, v) {\r\n    o["default"] = v;\r\n});\r\nvar __importStar = (this && this.__importStar) || function (mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\r\n    __setModuleDefault(result, mod);\r\n    return result;\r\n};\r\nvar __importDefault = (this && this.__importDefault) || function (mod) {\r\n    return (mod && mod.__esModule) ? mod : { "default": mod };\r\n};\r\nObject.defineProperty(exports, "__esModule", ({ value: true }));\r\nexports.api = void 0;\r\nconst express_1 = __importDefault(__webpack_require__(/*! express */ "express"));\r\nconst functions = __importStar(__webpack_require__(/*! firebase-functions */ "firebase-functions"));\r\nconst app = (0, express_1.default)();\r\napp.disable(\'x-powered-by\');\r\n// autentication check and log\r\nconst auth_1 = __webpack_require__(/*! ./middleware/auth */ "./src/https/middleware/auth.ts");\r\nconst logging_1 = __webpack_require__(/*! ./middleware/logging */ "./src/https/middleware/logging.ts");\r\napp.use(auth_1.tokenAuth, logging_1.logHandler);\r\napp.get(\'/api/user\', (req, res) => {\r\n    return res.status(200).json({ userId: req.locals.userId });\r\n});\r\nconst tasks_1 = __webpack_require__(/*! ./routes/tasks */ "./src/https/routes/tasks/index.ts");\r\napp.use(\'/api/tasks\', tasks_1.listener);\r\n// error handling\r\nconst error_handler_1 = __webpack_require__(/*! ./middleware/error-handler */ "./src/https/middleware/error-handler.ts");\r\napp.use(error_handler_1.errorHandler);\r\nexports.api = functions.runWith({ memory: \'512MB\', timeoutSeconds: 60 }).https.onRequest(app);\r\n\n\n//# sourceURL=webpack://functions/./src/https/index.ts?')},"./src/https/middleware/auth.ts":(__unused_webpack_module,exports,__webpack_require__)=>{eval("\r\nObject.defineProperty(exports, \"__esModule\", ({ value: true }));\r\nexports.tokenAuth = exports.Locals = void 0;\r\nconst firebase_admin_1 = __webpack_require__(/*! firebase-admin */ \"firebase-admin\");\r\nconst error_handler_1 = __webpack_require__(/*! ./error-handler */ \"./src/https/middleware/error-handler.ts\");\r\nclass Locals {\r\n}\r\nexports.Locals = Locals;\r\nconst tokenAuth = async (req, _, next) => {\r\n    try {\r\n        const user = (await (0, firebase_admin_1.auth)().verifyIdToken(req.headers.authorization || ''));\r\n        console.log(`${user.provider_id} | ${user.uid}`);\r\n        const locals = { ...req.locals, userId: user.uid };\r\n        req.locals = locals;\r\n        next();\r\n    }\r\n    catch (err) {\r\n        next(new error_handler_1.ApplicationError({ error: 'Invalid Token', err }, 'Invalid Token', 401));\r\n    }\r\n};\r\nexports.tokenAuth = tokenAuth;\r\n\n\n//# sourceURL=webpack://functions/./src/https/middleware/auth.ts?")},"./src/https/middleware/error-handler.ts":(__unused_webpack_module,exports)=>{eval("\r\nObject.defineProperty(exports, \"__esModule\", ({ value: true }));\r\nexports.errorHandler = exports.ApplicationError = void 0;\r\nclass ApplicationError extends Error {\r\n    constructor(\r\n    // FIXME: Poner un tipo estÃ¡ndar para errorObject\r\n    errorObject, publicMessage = 'Ha ocurrido un error', httpStatusCode = 500, eventType = 'unexpectedError') {\r\n        var _a;\r\n        super(publicMessage);\r\n        this.httpStatusCode = httpStatusCode;\r\n        this.eventType = eventType;\r\n        // tslint:disable-next-line:no-any\r\n        const stack = ((_a = errorObject === null || errorObject === void 0 ? void 0 : errorObject.error) === null || _a === void 0 ? void 0 : _a.stack) || (errorObject === null || errorObject === void 0 ? void 0 : errorObject.stack);\r\n        this.json = JSON.stringify({ ...errorObject, stack, publicMessage });\r\n        if (false)\r\n            {}\r\n    }\r\n}\r\nexports.ApplicationError = ApplicationError;\r\nconst getError = (err) => {\r\n    if (typeof err === 'string') {\r\n        return new ApplicationError({ error: err, message: `unexpected error (string) -- ${err}` });\r\n    }\r\n    else if (err instanceof ApplicationError) {\r\n        return err;\r\n    }\r\n    else {\r\n        return new ApplicationError({ error: err, message: `unexpected error -- ${err.name}: ${err.message}` });\r\n    }\r\n};\r\nconst errorHandler = async (err, req, res, next) => {\r\n    let error;\r\n    if (Array.isArray(err)) {\r\n        if (err.length > 1) {\r\n            const errors = err\r\n                .map(getError)\r\n                .map((e) => e.message)\r\n                .join('//');\r\n            error = new ApplicationError({ error: errors });\r\n        }\r\n        else if (err.length === 1) {\r\n            error = getError(err[0]);\r\n        }\r\n        else {\r\n            error = new ApplicationError({ error: 'empty error array' });\r\n        }\r\n    }\r\n    else {\r\n        error = getError(err);\r\n    }\r\n    try {\r\n        res.status(error.httpStatusCode).json({ message: error.message });\r\n    }\r\n    catch (e) {\r\n        try {\r\n            res.end();\r\n        }\r\n        catch (fe) {\r\n            console.log('request ended before error');\r\n            console.error(e, fe);\r\n        }\r\n    }\r\n};\r\nexports.errorHandler = errorHandler;\r\n\n\n//# sourceURL=webpack://functions/./src/https/middleware/error-handler.ts?")},"./src/https/middleware/logging.ts":(__unused_webpack_module,exports)=>{eval('\r\nObject.defineProperty(exports, "__esModule", ({ value: true }));\r\nexports.logHandler = void 0;\r\nconst logHandler = async (req, res, next) => {\r\n    const url = req.get("x-original-url") || req.originalUrl;\r\n    console.log(`${req.method} | ${url}`);\r\n    next();\r\n};\r\nexports.logHandler = logHandler;\r\n\n\n//# sourceURL=webpack://functions/./src/https/middleware/logging.ts?')},"./src/https/routes/tasks/index.ts":(__unused_webpack_module,exports,__webpack_require__)=>{eval('\r\nObject.defineProperty(exports, "__esModule", ({ value: true }));\r\nexports.listener = void 0;\r\nconst express_1 = __webpack_require__(/*! express */ "express");\r\nconst database_1 = __webpack_require__(/*! src/services/database */ "./src/services/database.ts");\r\nconst _models_1 = __webpack_require__(/*! @models */ "../shared/models/index.ts");\r\nconst router = (0, express_1.Router)();\r\nrouter.get(":id", async (req, res, next) => {\r\n    try {\r\n        const id = req.params.id;\r\n        const task = await (0, database_1.getDocument)((0, _models_1.getTaskPath)(id));\r\n        res.status(200).json({ task });\r\n    }\r\n    catch (error) {\r\n        next(error);\r\n    }\r\n});\r\nrouter.post("", async (req, res, next) => {\r\n    try {\r\n        const task = req.body.task;\r\n        if (task.userId !== req.locals.userId) {\r\n            return res.status(401).json({ success: false });\r\n        }\r\n        await (0, database_1.createDocPath)((0, _models_1.getTaskCollection)(), task);\r\n        return res.status(201).json({ success: true });\r\n    }\r\n    catch (error) {\r\n        return next(error);\r\n    }\r\n});\r\nrouter.patch(":id", async (req, res, next) => {\r\n    try {\r\n        const id = req.params.id;\r\n        const task = await (0, database_1.getDocument)((0, _models_1.getTaskPath)(id));\r\n        if (task.userId !== req.locals.userId) {\r\n            return res.status(401).json({ success: false });\r\n        }\r\n        await (0, database_1.updateDoc)((0, _models_1.getTaskPath)(task.id), task, true);\r\n        return res.status(200).json({ success: true });\r\n    }\r\n    catch (error) {\r\n        return next(error);\r\n    }\r\n});\r\nrouter.delete(":id", async (req, res, next) => {\r\n    try {\r\n        const id = req.params.id;\r\n        const task = await (0, database_1.getDocument)((0, _models_1.getTaskPath)(id));\r\n        if (task.userId !== req.locals.userId) {\r\n            return res.status(401).json({ success: false });\r\n        }\r\n        await (0, database_1.updateDoc)((0, _models_1.getTaskPath)(task.id), { isActive: false }, true);\r\n        return res.status(200).json({ success: true });\r\n    }\r\n    catch (error) {\r\n        return next(error);\r\n    }\r\n});\r\nexports.listener = router;\r\n\n\n//# sourceURL=webpack://functions/./src/https/routes/tasks/index.ts?')},"./src/index.ts":function(__unused_webpack_module,exports,__webpack_require__){eval('\r\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    var desc = Object.getOwnPropertyDescriptor(m, k);\r\n    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\r\n      desc = { enumerable: true, get: function() { return m[k]; } };\r\n    }\r\n    Object.defineProperty(o, k2, desc);\r\n}) : (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    o[k2] = m[k];\r\n}));\r\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\r\n    Object.defineProperty(o, "default", { enumerable: true, value: v });\r\n}) : function(o, v) {\r\n    o["default"] = v;\r\n});\r\nvar __importStar = (this && this.__importStar) || function (mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\r\n    __setModuleDefault(result, mod);\r\n    return result;\r\n};\r\nvar __exportStar = (this && this.__exportStar) || function(m, exports) {\r\n    for (var p in m) if (p !== "default" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);\r\n};\r\nObject.defineProperty(exports, "__esModule", ({ value: true }));\r\nconst node_path_1 = __webpack_require__(/*! node:path */ "node:path");\r\nconst admin = __importStar(__webpack_require__(/*! firebase-admin */ "firebase-admin"));\r\nif (true) {\r\n    process.env.GOOGLE_APPLICATION_CREDENTIALS = (0, node_path_1.resolve)(\'./test-app-27472-firebase-adminsdk-kotog-a74f5f1d81.json\');\r\n}\r\nadmin.initializeApp();\r\n__exportStar(__webpack_require__(/*! ./https */ "./src/https/index.ts"), exports);\r\n\n\n//# sourceURL=webpack://functions/./src/index.ts?')},"./src/services/database.ts":(__unused_webpack_module,exports,__webpack_require__)=>{eval('\r\nObject.defineProperty(exports, "__esModule", ({ value: true }));\r\nexports.getAuthUser = exports.updateDoc = exports.createDocPath = exports.getNewDocumentRef = exports.getDocumentRef = exports.getDocument = exports.getDocuments = exports.docExists = exports.projectId = void 0;\r\nconst firebase_admin_1 = __webpack_require__(/*! firebase-admin */ "firebase-admin");\r\nconst error_handler_1 = __webpack_require__(/*! src/https/middleware/error-handler */ "./src/https/middleware/error-handler.ts");\r\nconst db = (0, firebase_admin_1.firestore)();\r\nexports.projectId = process.env.GCP_PROJECT || process.env.GCLOUD_PROJECT || (0, firebase_admin_1.installations)().app.options.projectId || \'\';\r\nconst docExists = async (path) => {\r\n    const snapshot = await (0, exports.getDocumentRef)(path).get();\r\n    return snapshot.exists;\r\n};\r\nexports.docExists = docExists;\r\nconst getDocuments = async (collection, filters = []) => {\r\n    let collectionRef = db.collection(collection);\r\n    filters.map((f) => {\r\n        const [fieldPath, opStr, value] = f;\r\n        collectionRef = collectionRef.where(fieldPath, opStr, value);\r\n    });\r\n    return (await collectionRef.get()).docs.map((entity) => Object.assign(entity.data(), {\r\n        id: entity.id,\r\n    }));\r\n};\r\nexports.getDocuments = getDocuments;\r\nconst getDocument = async (path) => {\r\n    const snapshot = await db.doc(path).get();\r\n    if (snapshot.exists) {\r\n        return Object.assign(snapshot.data(), { id: snapshot.id });\r\n    }\r\n    else {\r\n        throw new error_handler_1.ApplicationError({ error: `no document found: ${path}` });\r\n    }\r\n};\r\nexports.getDocument = getDocument;\r\nconst getDocumentRef = (path) => db.doc(path);\r\nexports.getDocumentRef = getDocumentRef;\r\nconst getNewDocumentRef = (collection) => db.collection(collection).doc();\r\nexports.getNewDocumentRef = getNewDocumentRef;\r\nconst createDocPath = (path, data) => {\r\n    return db.collection(path).add(data);\r\n};\r\nexports.createDocPath = createDocPath;\r\nconst updateDoc = async (path, data, override) => {\r\n    const snapshot = await db.doc(path).get();\r\n    if (!snapshot.exists && !override)\r\n        return Promise.resolve();\r\n    return snapshot.ref.set({ ...snapshot.data(), ...data }, { merge: override });\r\n};\r\nexports.updateDoc = updateDoc;\r\nconst getAuthUser = async (userId) => {\r\n    return (0, firebase_admin_1.auth)().getUser(userId);\r\n};\r\nexports.getAuthUser = getAuthUser;\r\n\n\n//# sourceURL=webpack://functions/./src/services/database.ts?')},"../shared/models/base.ts":(__unused_webpack_module,exports)=>{eval("\r\nObject.defineProperty(exports, \"__esModule\", ({ value: true }));\r\nexports.path = exports.BaseObject = void 0;\r\nclass BaseObject {\r\n    constructor() {\r\n        this.isActive = true;\r\n        this.timestamp = new Date();\r\n    }\r\n}\r\nexports.BaseObject = BaseObject;\r\nexports.path = {\r\n    join: (...paths) => paths\r\n        .map((part) => part.trim().replace(/(^[\\/]*|[\\/]*$)/g, ''))\r\n        .filter((x) => x.length > 0)\r\n        .join('/'),\r\n};\r\n\n\n//# sourceURL=webpack://functions/../shared/models/base.ts?")},"../shared/models/index.ts":function(__unused_webpack_module,exports,__webpack_require__){eval('\r\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    var desc = Object.getOwnPropertyDescriptor(m, k);\r\n    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\r\n      desc = { enumerable: true, get: function() { return m[k]; } };\r\n    }\r\n    Object.defineProperty(o, k2, desc);\r\n}) : (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    o[k2] = m[k];\r\n}));\r\nvar __exportStar = (this && this.__exportStar) || function(m, exports) {\r\n    for (var p in m) if (p !== "default" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);\r\n};\r\nObject.defineProperty(exports, "__esModule", ({ value: true }));\r\n__exportStar(__webpack_require__(/*! ./base */ "../shared/models/base.ts"), exports);\r\n__exportStar(__webpack_require__(/*! ./tasks */ "../shared/models/tasks.ts"), exports);\r\n\n\n//# sourceURL=webpack://functions/../shared/models/index.ts?')},"../shared/models/tasks.ts":(__unused_webpack_module,exports,__webpack_require__)=>{eval('\r\nObject.defineProperty(exports, "__esModule", ({ value: true }));\r\nexports.getTaskPath = exports.getTaskCollection = exports.taskCollectionGroup = exports.Task = void 0;\r\nconst base_1 = __webpack_require__(/*! ./base */ "../shared/models/base.ts");\r\nclass Task extends base_1.BaseObject {\r\n}\r\nexports.Task = Task;\r\nexports.taskCollectionGroup = `tasks`;\r\nconst getTaskCollection = () => base_1.path.join(exports.taskCollectionGroup);\r\nexports.getTaskCollection = getTaskCollection;\r\nconst getTaskPath = (taskId) => base_1.path.join((0, exports.getTaskCollection)(), taskId);\r\nexports.getTaskPath = getTaskPath;\r\n\n\n//# sourceURL=webpack://functions/../shared/models/tasks.ts?')},express:e=>{e.exports=require("express")},"firebase-admin":e=>{e.exports=require("firebase-admin")},"firebase-functions":e=>{e.exports=require("firebase-functions")},"node:path":e=>{e.exports=require("node:path")}},__webpack_module_cache__={};function __webpack_require__(e){var r=__webpack_module_cache__[e];if(void 0!==r)return r.exports;var t=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e].call(t.exports,t,t.exports,__webpack_require__),t.exports}var __webpack_exports__=__webpack_require__("./src/index.ts"),__webpack_export_target__=this;for(var i in __webpack_exports__)__webpack_export_target__[i]=__webpack_exports__[i];__webpack_exports__.__esModule&&Object.defineProperty(__webpack_export_target__,"__esModule",{value:!0})})();